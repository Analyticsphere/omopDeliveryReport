# OMOP Delivery Report Generator

Generates HTML reports from OMOP CDM delivery metrics and data quality results. Part of the [Connect for Cancer Prevention](https://www.cancer.gov/connect-prevention-study/) EHR data/OMOP pipeline.

## Pipeline Position

This package operates downstream in the processing pipeline:

1. **[ccc-omop-file-processor](https://github.com/Analyticsphere/ccc-omop-file-processor)** - Processes OMOP files, performs vocabulary harmonization, outputs `delivery_report.csv`
2. **[DataQualityDashboard](https://github.com/OHDSI/DataQualityDashboard)** - Runs quality checks (via [ccc-omop-analyzer](https://github.com/Analyticsphere/ccc-omop-analyzer)), outputs `dqd_results.csv`
3. **omopDeliveryReport** (this package) - Combines both CSVs into HTML report

## Installation

```r
remotes::install_github("Analyticsphere/omop-delivery-report")
```

Sample input files and a rendered report are available in `inst/ref/`.

## Usage

```r
library(omopDeliveryReport)

generate_omop_report(
  delivery_report_path = "delivery_report.csv",
  dqd_results_path = "dqd_results.csv",
  output_path = "report.html"
)
```

### GCS Support

```r
generate_omop_report(
  delivery_report_path = "gs://bucket/delivery_report.csv",
  dqd_results_path = "gs://bucket/dqd_results.csv",
  output_path = "gs://bucket/report.html"
)
```

## Input Files

### delivery_report.csv

Generated by `ccc-omop-file-processor` via `/generate_delivery_report` endpoint.

**Contents:**
- Table row counts (initial, invalid, harmonized, final)
- Vocabulary harmonization statistics
- Domain migration flows
- Type concept breakdowns
- Time series data
- Reference integrity results

### dqd_results.csv

Standard output from OHDSI DataQualityDashboard. Contains check results, failure counts, and check metadata organized by table, field, and check category.

## Architecture

```
CSV → Parse → Calculate → Aggregate → Format → Render → HTML
```

**Components:**
- **data_loaders.R** - CSV I/O (local and GCS via `googleCloudStorageR`)
- **data_parsers.R** - Regex-based metric extraction using `.METRIC_PARSERS` configuration
- **metrics.R** - Metric calculations, alert thresholds, formatting
- **data_preparation.R** - Data aggregation and transformation for display
- **report_builder.R** - HTML assembly and JSON serialization
- **template_renderer.R** - Variable substitution in HTML templates
- **constants.R** - Package constants (colors, table groups, thresholds)

## Package Structure

```
R/
├── generate_report.R     - Entry point
├── data_loaders.R        - File I/O
├── data_parsers.R        - Metric extraction
├── metrics.R             - Calculations
├── data_preparation.R    - Aggregation
├── report_builder.R      - HTML assembly
├── template_renderer.R   - Template engine
├── constants.R           - Constants
└── utils.R               - Utilities

inst/
├── ref/                  - Sample data
└── templates/
    └── main.html         - Report template
```