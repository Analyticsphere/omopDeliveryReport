# OMOP Delivery Report Generator

Generates HTML reports from OMOP CDM delivery metrics and data quality results. Part of the [Connect for Cancer Prevention](https://www.cancer.gov/connect-prevention-study/) EHR data/OMOP pipeline.

## Pipeline Position

This package operates downstream in the processing pipeline:

1. **[ccc-omop-file-processor](https://github.com/Analyticsphere/ccc-omop-file-processor)** - Processes OMOP files, performs vocabulary harmonization, outputs `delivery_report.csv`
2. **[DataQualityDashboard](https://github.com/OHDSI/DataQualityDashboard)** - Runs quality checks (via [ccc-omop-analyzer](https://github.com/Analyticsphere/ccc-omop-analyzer)), outputs `dqd_results.csv`
3. **[Profile of Analytic Suitability Score (PASS)](https://github.com/Analyticsphere/PASS)** - Evaluates data fitness-for-purpose across six dimensions and generates PASS metric files
4. **omopDeliveryReport** (this package) - Combines all reporting outputs into a single HTML report

## Installation

```r
remotes::install_github("Analyticsphere/omopDeliveryReport")
```

Sample input files and a rendered report are available in `inst/ref/`.

## Usage

```r
library(omopDeliveryReport)

# Local file system
generate_omop_report(
  delivery_report_path = "inst/ref/delivery_report.csv",  # Sample data in package
  dqd_results_path = "inst/ref/dqd_results.csv",          # Sample data in package
  pass_results_path = "inst/ref/example_pass",            # Sample data in package
  output_path = "~/Desktop/example_omop_report.html"
)

# Files in GCS
generate_omop_report(
  delivery_report_path = "gs://bucket/delivery_report.csv",
  dqd_results_path = "gs://bucket/dqd_results.csv",
  pass_results_path = "gs://bucket/example_pass",
  output_path = "gs://bucket/report.html"
)
```

## Input Files

### delivery_report.csv

Generated by `ccc-omop-file-processor` via `/generate_delivery_report` endpoint.

**Contents:**
- Table row counts (initial, invalid, harmonized, final)
- Vocabulary harmonization statistics
- Domain migration flows
- Type concept breakdowns
- Time series data
- Reference integrity results

### dqd_results.csv

Standard output from OHDSI DataQualityDashboard. Contains check results, failure counts, and check metadata organized by table, field, and check category.

### PASS Results Directory

Generated by the [PASS R package](https://github.com/Analyticsphere/PASS). The `pass_results_path` should point to a directory containing the following CSV files:

**Required Files:**
- `pass_overall.csv` - Overall scores for each metric with confidence intervals
- `pass_table_level.csv` - Metric scores aggregated by OMOP table
- `pass_field_level.csv` - Detailed scores for individual concept fields
- `pass_composite_overall.csv` - Weighted composite score across all metrics
- `pass_composite_components.csv` - Individual metric contributions to composite score

## Architecture

**Processing Pipeline:**
```
Load CSV → Parse Metrics → Calculate Scores → Build HTML → Write Output
```

The package combines two CSV files (delivery metrics and DQD results) into a single interactive HTML report. Each R module handles one stage of the processing pipeline. Parsers extract metrics using regex patterns, calculators compute scores, and builders assemble HTML from templates using `{{variable}}` substitution. Works with both local files and Google Cloud Storage.

**Package Structure:**
```
R/
├── generate_report.R     - Main entry point
├── data_loaders.R        - CSV loading & schema validation
├── data_parsers.R        - Metric extraction
├── metrics.R             - Score calculations
├── data_preparation.R    - Data aggregation for display
├── report_builder.R      - HTML and JSON assembly
├── template_renderer.R   - Template variable substitution
├── constants.R           - Package constants
└── utils.R               - File I/O and helper functions

inst/
├── ref/                  - Sample files
├── css/                  - Report styling
├── js/                   - Interactive features
└── templates/
    ├── main.html         - Main report template
    ├── sections/         - Section templates
    └── components/       - Reusable HTML components
```